import{f as me,c as C,v as fe,r as w,u as Ae,o as he,a as n,b as c,d as t,e as k,g as D,I as H,t as y,h as g,D as Se,i as Ee,j as Ue,k as re,l as Ce,m as Re,n as J,p as Ie,w as ne,T as ce,q as K,_ as Te,s as W,F as Fe,x as He,y as Z,z as ie,A as le,B as ue,C as Le,E as Me,G as je,N as de}from"./index-htZnyubk.js";import{i as $e}from"./isValidEmail-BQNythMj.js";import{a as pe}from"./axios-B4uVmeYG.js";import{_ as Pe}from"./MainButton-DJMPo5N5.js";const Ge={class:"flex justify-between gap-x-2 items-center"},Qe={class:"flex items-center gap-x-4"},Je={className:"w-20 h-20 shrink-0 rounded-xl overflow-clip bg-secondary_bg_color"},Ne={key:0,class:"w-full h-full"},qe=["src"],Ve={key:1,class:"w-full h-full"},Ye=["src"],Xe={key:2,class:"w-full h-full"},Ke=["src"],We={key:3,class:"flex justify-center items-center w-full h-full"},Ze={class:"flex flex-col"},ze={class:"flex items-center gap-x-2"},et={class:"flex text-lg gap-x-1"},tt=t("span",null,"₽",-1),ot={key:0,class:"bg-green text-white px-2 py-1 rounded-lg text-xs font-bold"},st={class:"line-clamp-1"},at={class:"text-sm text-hint_color line-clamp-1"},rt={__name:"Item",props:{product:Object,sale_prices:Array,discount:{type:Number,required:!1,default:0}},setup(u){const B=me(C.DIRECTUS.API).with(fe()),R=w(!0),L=Ae(),e=u,E=()=>{L.setOrderInBasket(e.product)},I=async f=>{console.log(e.product);let d=e.product.productOption.productCollection;if(d)try{let _=await B.request(Se(d,f,{fields:["date_updated","status"]}));_&&(_.date_updated!==e.product.product.date_updated||_.status!=="published")&&E()}catch{E()}R.value=!1},M=w(null);return he(async()=>{await I(e.product.product.id),M.value=e.sale_prices.includes(e.product.product.platform),M.value||e.product.productOption.productCollection==="Games"&&e.product.productOption.plan.id!=="price_standart"&&E()}),(f,d)=>{var _,T;return n(),c("div",Ge,[t("div",Qe,[t("div",Je,[u.product.product.cover_link?(n(),c("div",Ne,[t("img",{src:u.product.product.cover_link,class:"w-full h-full object-cover rounded-xl"},null,8,qe)])):u.product.product.cover?(n(),c("div",Ve,[t("img",{src:k(C).DIRECTUS.API+"/assets/"+u.product.product.cover.filename_disk,class:"object-cover w-full h-full rounded-xl"},null,8,Ye)])):u.product.product.images&&u.product.product.images.length>0?(n(),c("div",Xe,[t("img",{src:k(C).DIRECTUS.API+"/assets/"+u.product.product.images[0].directus_files_id.id,class:"w-full h-full object-cover rounded-xl"},null,8,Ke)])):(n(),c("span",We,[D(k(H),{icon:"hugeicons:image-not-found-02",class:"text-3xl"})]))]),t("div",Ze,[t("div",ze,[t("span",et,[t("span",null,y(u.product.productOption.plan.price-u.discount),1),tt]),e.discount>0?(n(),c("span",ot," -"+y(e.discount.toLocaleString("ru-RU"))+" ₽ ",1)):g("",!0)]),t("span",st,y(u.product.product.title)+" "+y(((_=u.product.productOption.subscribe)==null?void 0:_.title)&&u.product.productOption.subscribe.title)+" "+y(((T=u.product.productOption.plan)==null?void 0:T.title)&&u.product.productOption.plan.title),1),t("span",at,y(u.product.product.compatible_platforms),1)])]),t("button",{onClick:E,class:"w-12 h-12 rounded-full flex justify-center items-center"},[D(k(H),{icon:"mingcute:close-fill",class:"text-2xl"})])])}}},nt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA9CAYAAAAeYmHpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAADvSURBVHgB7drNDcIwDEBhhwkYgVXYlA1gg4oJygZlBDYwqWgOVFT9SavG5j3Jyvmre4oiskOqeopTtaf8Qx240U+Ne3gPrO7hA2C/8BGwP/hEsB/4TLB9+EKwXXgmeHP4QTYohPCMx13yOsWp1ODGL5pfA9xKwIEDBw4cOHDgwK0EHDhw4MCBA/+CBzFSt6U6zlHyuomFdJ0r5bY6Tu5H2z7AgAEDBlxygAEDBgy45AADBgwYcMkBLgy8yTPJlXrEOYcQXmKlzG3b+KV/tRBuF5yaCbcPTk2E+wGnRuD+wKkBuF9wqgf3D0518Ote4DeW7t8w/ppZDQAAAABJRU5ErkJggg==",ct="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA9CAYAAAAeYmHpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAHISURBVHgB1drBUcJAGMXxDeBBbSKlSA8cuDl0YgeWoEeOdMDYgSVQAuPFGZgE85yJw0EFsvve9/hfIJz4TSC72WyVAvqcz+umaV7G4/HidrncJHGjJO4b3Lbr7u1DB1/jOImrkrAf8OFQH3286c74VHnGZeg/wH1SuAR9Atwng9PRZ4L7JHAq+kJwHx1OQw8E91HhFHQmuI8Gp4zT+KJt276lvGrWOE79T3/MZq+jqnpMeRU/4/SrtyNcMk67wWUzMie4dO7tApeikQNcjkbR8BA0ioSHoVEUPBSNIuDhaKSGW6CREm6DRiq4FRop4HZoxIZbohETbotGLLg1GjHg9mhUGn4VaFQSLn+AN7SbyeSpe9mmvOpuwfL5Ks50oSVl9H6/30/t0cXBq9XWGs0A48AWzQIjSzQTjOzQbDCyQivAyAatAiMLtBKMwtFqMApFR4BRGDoKjELQkWAkR0eDkcM2ySENBiOXbZKXlAVGTtskzykbjNy2Sf5XETBy3Cb5W8XAyHWb5HFFwch5myQqDkbOq6EUMHL9edPAyPFCRgUjtyGLDkZOkxMJGLlMQ2Vg5HDDIQWj6FtLORiFLSLg6eHdbrdQg9EXpk1gLN6zRw4AAAAASUVORK5CYII=",it="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA9CAYAAAAeYmHpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAHrSURBVHgB1drLTcNAFIXhGZtQR1pJCdkhgUTohA4oAS9ZIJEOEB1QQkrICiFQbHwijRCPPOyZe+7JLyVydvnsxB6PJwaHFk+L6We3uZ/E+qaZN6tALgZyAH+0m+d+c9q/VudVPWPDqehf4BQdTkPvAKeocAr6ADhFg5ujjwSnKHBT9EBwyhxuhh4JTpnCTdCZ4JQZvAoG4YvGrnsJeW13HHZgKJzpf/ry8arpYrwOeRU/4uZnb0U45TqtBqeNyJTg1LG3Cpx+l6UAp6ORN9wFjTzhbmjkBXdFIw+4Oxqx4RJoxITLoBELLoVGDLgcGlnDJdHIEi6LRlZwaTSygMujUWn4SaBRSbjJxKBFk/rsNsawDnlhsvHuJI50oSnlELr4+lZXM3l0afBy3qyl0RZgfJRFW4GRJNoSjOTQ1mAkhWaAkQyaBUYSaCYYuaPZYOSK9gAjN7QXGLmgPcHIe5nk+EaCkcIyyeFlgJHKMsnjywQjpWWShysARmrLJHdXCIwUl0n+rSAYqS6T/K4wGCkvkzQBI5PZ0Pfte+b+NAIjs5/3RX+0q7btj3Y3DUMzBCPTE9kouDEYmV+yBsEJYEQZnBwFJ4ERbRi6F04EI+oNx79wMhjRby1/wB3AiP7U8qF/PtxW1azfXHqA0Rfy1ynjt/JnTwAAAABJRU5ErkJggg==",lt={class:"min-h-[100vh] pt-20 overflow-y-auto flex flex-col"},ut={class:"pb-4"},dt={class:"flex flex-col"},pt={key:0,class:"px-4 pb-2.5"},mt=t("span",null,"Назад",-1),ft={key:0,class:"px-4 flex flex-col gap-y-4"},At={class:"flex text-xl justify-between items-center font-medium"},ht=t("h2",null,"Корзина",-1),gt={key:0,class:"flex flex-col gap-y-2"},bt={class:"relative"},xt={class:"flex flex-col py-2 gap-y-6"},_t=t("hr",{class:"border-hint_color"},null,-1),vt={class:"flex flex-col gap-y-1"},wt=t("span",{class:"font-medium"},"У меня есть промокод",-1),yt={class:"w-8 h-8 rounded-lg bg-white shadow-sm overflow-clip"},kt={key:0,class:"flex w-full h-full justify-center items-center from-[#6BF792] to-[#36A254] bg-gradient-to-b rounded-lg"},Bt={key:0,class:"flex flex-col gap-y-2"},Dt={key:0,class:"text-sm text-red mt-2"},Ot={key:1,class:"text-sm text-green mt-2"},St=t("hr",{class:"border-hint_color"},null,-1),Et={class:"flex flex-col gap-y-1"},Ut=t("span",{class:"font-medium"},"У меня нет аккаунта",-1),Ct={class:"w-8 h-8 rounded-lg bg-white shadow-sm overflow-clip"},Rt={key:0,class:"flex w-full h-full justify-center items-center from-[#6BF792] to-[#36A254] bg-gradient-to-b rounded-lg"},It=t("p",{class:"text-sm text-hint_color w-[80%]"},"Отметьте, если вам нужна помощь в создании. Это бесплатно.",-1),Tt={class:"flex flex-col gap-y-2"},Ft={key:0,class:"text-sm text-red"},Ht={key:0,class:"absolute p-4 flex justify-center items-center top-0 left-0 right-0 bottom-0 rounded-xl border-[1.5px] border-hint_color bg-[#373737] bg-opacity-[90%] backdrop-blur-sm"},Lt=t("div",{class:"flex flex-col gap-y-4 justify-center items-center"},[t("h3",{class:"font-medium text-center"},"Проводятся технические работы"),t("span",{class:"text-hint_color text-sm text-center"},"Мы скоро вернёмся и обязательно оповестим в чате")],-1),Mt=[Lt],jt=t("span",{class:"text-xl"},"Корзина пуста",-1),$t=[jt],qt={__name:"Index",setup(u){const B=me(C.DIRECTUS.API).with(fe()),R=Ae(),L=Ee();Ue();const e=window.Telegram.WebApp,E=w(!0);console.log("tes");const I=()=>{L.go(-1)},M=w("Xbox"),f=re(()=>R.orders),d=w(null),_=async()=>{let a=await B.request(K("start_params",{fields:["*.*.*"]}));d.value=a},T=w(document.documentElement.clientHeight),z=()=>{T.value=document.documentElement.clientHeight};Ce(()=>{q(),window.addEventListener("resize",z);const a=window.localStorage.getItem("activeTab");a&&(M.value=JSON.parse(a).platform),e.onEvent("backButtonClicked",I),e.BackButton.show(),Me(()=>f.value.length,o=>{q()}),e.onEvent("mainButtonClicked",N)}),he(async()=>{q(),await _(),E.value=!1}),Re(()=>{$(),window.removeEventListener("resize",z),e.offEvent("backButtonClicked",I),e.BackButton.hide(),e.offEvent("mainButtonClicked",N),e.MainButton.hide(),e.MainButton.enable(),V(),m.value="default",i.checkbox=!1,i.promocode="",b.error=!1,b.message=""});const j=w("Оформить заказ"),N=async()=>{if(await te(),!P.value){if(i.checkbox&&await ee(),i.checkbox&&i.promocode===""){console.log(i.promocode),b.error=!0,m.value="error",b.message="Обязательное поле",e.HapticFeedback.notificationOccurred("error");return}else if(A.mail){if(!$e(A.mail)){v.error=!0,v.message="Некорректно введён e-mail",e.HapticFeedback.notificationOccurred("error");return}}else{v.error=!0,v.message="Обязательное поле",e.HapticFeedback.notificationOccurred("error");return}d.value.sale==="MANUAL"?await ve():d.value.sale==="TEST_TINKOFF"?await testMode():d.value.sale==="PROD_TINKOFF"&&await prodMode()}},q=()=>{var a;if(f&&f.value.length>0){e.MainButton.enable(),j.value="Оформить заказ";const o=window.localStorage.getItem("activeTab");if(e.MainButton.color=JSON.parse(o).color,e.MainButton.show(),((a=d.value)==null?void 0:a.sale)==="OFF")return}else e.MainButton.disable(),j.value="Пока нечего оформлять",e.MainButton.color="#5A5A5A",e.MainButton.show();e.MainButton.text=j.value,e.MainButton.show()},ee=async()=>{var o,h;if(await te(),!i.promocode){b.message="Обязательное поле",m.value="error";return}let a=!1;for(const s of f.value){s.discount=0;const r=(s.product.promocode||"").split(",").map(x=>x.trim()).filter(x=>x!=="");if(r.length!==0)for(const x of r){const F=await B.request(K("Promocodes",{filter:{code:{_eq:x.toUpperCase()}}}));if(F.length>0){const O=F[0];if(O.code.toUpperCase()===i.promocode.toUpperCase()){m.value="success",b.message="";const G=((h=(o=s.productOption)==null?void 0:o.plan)==null?void 0:h.price)||0;O.promo_procent>0?s.promocodeDiscount=Math.round(G*O.promo_procent/100):s.promocodeDiscount=O.promo_amount,s.discount=s.promocodeDiscount,a=!0;break}}}}a||(V(),b.message="Такого промокода нет",m.value="error")},te=async()=>{try{for(let a of f.value){const o=await B.request(K("Games",{filter:{id:{_eq:a.product.id}},fields:["*.*"]}));o&&o.length>0&&(a.product=o[0])}}catch(a){console.error("Ошибка при обновлении данных корзины:",a)}},U=re(()=>R.orders.reduce((a,o)=>{var s,p;const h=(((p=(s=o.productOption)==null?void 0:s.plan)==null?void 0:p.price)||0)-(o.discount||0);return a+Math.max(h,0)},0)),A=J({mail:"",checkbox:!1}),oe=()=>{const a=document.querySelector("body");a&&a.classList.add("pb-80")},$=()=>{const a=document.querySelector("body");a&&a.classList.remove("pb-80")},v=J({error:!1,message:""}),b=J({error:!1,message:""}),i=J({promocode:"",checkbox:!1}),ge={default:{image:nt,borderColor:"border-transparent"},error:{image:ct,borderColor:"border-red"},success:{image:it,borderColor:"border-green"}},m=w("default"),V=async()=>{f.value.forEach(a=>{a.discount=0})},be=()=>{m.value="default"},xe=async()=>{var o,h;let a=[];for(const s of f.value){let p=s.product.platform+" | "+s.product.title;(o=s.productOption.subscribe)!=null&&o.title&&(p=p+" "+s.productOption.subscribe.title),(h=s.productOption.plan)!=null&&h.title&&(p=p+" "+s.productOption.plan.title),console.log(s.discount);const r={Games:{game:s.product.id,about:p,price:s.productOption.plan.price,type:s.productOption.plan.id,discount:s.discount},Subscriptions:{subscription:s.product.id,about:p,price:s.productOption.plan.price,discount:s.discount},Donations:{donation:s.product.id,about:p,price:s.productOption.plan.price,discount:s.discount}};a.push(r[s.productOption.productCollection])}return a},P=w(!1),_e=async()=>{var h,s,p,r,x,F,O,G,se;P.value=!0,e.MainButton.showProgress(),e.MainButton.disable();const a=await xe(),o=await B.request(je("order",a));if((h=e.initDataUnsafe.user)!=null&&h.id){let Y=o.map((l,S)=>`${S+1}. ${l.about} - ${l.price-l.discount} ₽${l.type&&l.type==="price_subscription"?" (цена по подписке)":""}${m.value==="success"&&l.discount>0?` - промокод ${i.promocode.toUpperCase()}`:""}`),Q=o.map((l,S)=>`${S+1}. ${l.about} - ${l.price-l.discount} ₽${l.type&&l.type==="price_subscription"?" (цена по подписке)":""}${m.value==="success"&&l.discount>0?` - промокод ${i.promocode.toUpperCase()}`:""}`),X=`<b>Состав заказа:</b>
${Y.join(`
`)}

<b>Сумма заказа:</b> ${U._value.toLocaleString("ru-RU")} ₽`,ye=`<b>Состав заказа:</b>
${Q.join(`
`)}

<b>Сумма заказа:</b> ${U._value.toLocaleString("ru-RU")} ₽`,ae,ke=[];d.value.sale==="MANUAL"&&(ae=ye+`

Ссылка на оплату формируется и будет отправлена вам в этом чате.

    // Обратите внимание: заказы исполняются ежедневно с 11:00 до 23:00 по московскому времени. `);const Be=o.map(l=>({order_id:l.id}));if(await B.request(de("orders",{user:((p=e.initDataUnsafe.user)==null?void 0:p.id)||null,products:Be,email:A.mail,help_with_creation:A.checkbox,total_price:U._value}))){let l=(r=e.initDataUnsafe.user)==null?void 0:r.id;if((x=d.value)!=null&&x.admin_chat&&d.value.sale==="MANUAL"){let S=`<b>Новый заказ! 🔥🔥🔥</b>

${X}${A.checkbox?`

⚡️НУЖНО ПОМОЧЬ С АККАУНТОМ⚡️`:""}

Пользователь: <a href='tg://user?id=${(F=e.initDataUnsafe.user)==null?void 0:F.id}'>${(O=e.initDataUnsafe.user)==null?void 0:O.first_name}</a> ${(G=e.initDataUnsafe.user)!=null&&G.username?"@"+e.initDataUnsafe.user.username:""}
ID: ${(se=e.initDataUnsafe.user)==null?void 0:se.id}
Почта: ${A.mail}`,De=d.value.admin_chat;try{await pe.post(C.BOT+"/api/send-message",{message:S,chatIds:[De],buttons:[]})}catch(Oe){console.log(Oe)}}if(l)try{await pe.post(C.BOT+"/api/send-message",{message:ae,chatIds:[l],buttons:ke})}catch(S){console.log(S)}window.localStorage.removeItem("basket-store"),R.orders=[],e.close()}e.MainButton.hideProgress(),e.MainButton.enable()}else{const Y=o.map(X=>({order_id:X.id})),Q=await B.request(de("orders",{user:((s=e.initDataUnsafe.user)==null?void 0:s.id)||null,products:Y,email:A.mail,help_with_creation:A.checkbox,total_price:U._value}));Q&&L.push({name:"ORDER",params:{id:Q.id}})}P.value=!1},ve=async()=>{await _e()},we=async()=>{i.checkbox&&(V(),m.value="default",i.promocode="",b.error=!1,b.message=""),i.checkbox=!i.checkbox};return(a,o)=>{const h=Ie("auto-animate");return n(),c("main",lt,[t("div",ut,[t("div",dt,[D(Te),k(e).initDataUnsafe.user?g("",!0):(n(),c("div",pt,[t("button",{onClick:I,class:"flex bg-blue w-fit pl-2 pr-4 py-1.5 rounded-xl items-center gap-x-1 font-medium"},[D(k(H),{icon:"ion:chevron-back-outline"}),mt])])),D(ce,{name:"fade",appear:""},{default:ne(()=>{var s,p;return[f.value&&f.value.length>0?(n(),c("div",ft,[t("div",At,[ht,t("span",null,y(U.value&&U.value.toLocaleString("ru-RU"))+" ₽",1)]),d.value?W((n(),c("div",gt,[(n(!0),c(Fe,null,He(f.value,(r,x)=>(n(),ue(rt,{key:x,product:r,sale_prices:d.value.sale_prices,discount:m.value!="error"?r.discount:void 0},null,8,["product","sale_prices","discount"]))),128))])),[[h]]):g("",!0),t("div",bt,[t("div",xt,[_t,t("div",vt,[t("button",{onClick:o[0]||(o[0]=r=>we()),class:"flex pr-1.5 justify-between text-start gap-x-2 items-center w-full"},[wt,t("span",yt,[i.checkbox?(n(),c("span",kt,[D(k(H),{icon:"mdi:check-bold",class:"text-2xl"})])):g("",!0)])])]),i.checkbox?(n(),c("div",Bt,[t("div",{class:Z(["flex items-center rounded-xl bg-hint_bg_color border-[1.5px]",ge[m.value].borderColor])},[W(t("input",{class:Z(["bg-hint_bg_color placeholder:text-hint_color pl-4 pr-2 py-3 outline-none rounded-xl flex-grow float-left",m.value==="error"?"text-red":m.value==="success"?"text-green":"text-white"]),"onUpdate:modelValue":o[1]||(o[1]=r=>i.promocode=r),type:"text",placeholder:"Введите промокод",onFocus:o[2]||(o[2]=r=>{be(),oe(r)}),onBlur:$,onKeyup:o[3]||(o[3]=le(r=>{r.target.blur(),$()},["enter"]))},null,34),[[ie,i.promocode]]),t("button",{class:"bg-bg_color text-white rounded-md px-2 py-1 mr-2 active:bg-2A2A2A",onClick:ee}," Применить ")],2),m.value==="error"?(n(),c("span",Dt,y(b.message),1)):g("",!0),m.value==="success"?(n(),c("span",Ot,"Промокод успешно применен!")):g("",!0)])):g("",!0),St,t("div",Et,[t("button",{onClick:o[4]||(o[4]=()=>A.checkbox=!A.checkbox),class:"flex pr-1.5 justify-between text-start gap-x-2 items-center w-full"},[Ut,t("span",Ct,[A.checkbox?(n(),c("span",Rt,[D(k(H),{icon:"mdi:check-bold",class:"text-2xl"})])):g("",!0)])]),It]),t("div",Tt,[W(t("input",{class:Z(["bg-hint_bg_color px-4 py-3 rounded-xl placeholder:text-hint_color outline-none border-[1.5px] float-left",v.error?"border-red":"border-transparent"]),"onUpdate:modelValue":o[5]||(o[5]=r=>A.mail=r),onKeyup:o[6]||(o[6]=le(r=>r.target.blur(),["enter"])),type:"email",placeholder:"Введите e-mail для чека",onFocus:o[7]||(o[7]=r=>{v.error=!1,oe(r)}),onBlur:$},null,34),[[ie,A.mail]]),v.error&&v.message?(n(),c("span",Ft,y(v.message),1)):g("",!0)])]),D(ce,{name:"fade"},{default:ne(()=>{var r;return[((r=d.value)==null?void 0:r.sale)==="OFF"?(n(),c("div",Ht,Mt)):g("",!0)]}),_:1})]),!((s=k(e).initDataUnsafe)!=null&&s.user)&&((p=d.value)==null?void 0:p.sale)!=="OFF"?(n(),ue(Pe,{key:1,title:j.value,onSubmit:N,buttonLoader:P.value},null,8,["title","buttonLoader"])):g("",!0)])):(n(),c("div",{key:1,style:Le({height:`${T.value-142}px`}),class:"flex justify-center items-center"},$t,4))]}),_:1})])])])}}};export{qt as default};
